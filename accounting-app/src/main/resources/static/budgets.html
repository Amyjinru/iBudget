    async function usageInfo(userBudget){
        const q=new URLSearchParams({year:userBudget.year,month:userBudget.month}); if(userBudget.categoryId) q.set('categoryId',userBudget.categoryId)
        return await fetchJSON(base+'/budgets/usage?'+q.toString())
    }
    
    // è·å–é¢„ç®—ç»Ÿè®¡æ•°æ®
    async function getStats(budgetId){
        try{
            return await fetchJSON(base+'/budgets/stats/'+budgetId)
        }catch(e){
            console.error('è·å–ç»Ÿè®¡å¤±è´¥:',e)
            return null
        }
    }
    
    // æ ¼å¼åŒ–å‘¨æœŸæ˜¾ç¤º
    function formatPeriod(b){
        if(b.startDate && b.periodUnit){
            const unitMap={DAYS:'å¤©',WEEKS:'å‘¨',MONTHS:'æœˆ',YEARS:'å¹´'}
            const unit=unitMap[b.periodUnit]||b.periodUnit
            return `${b.startDate} èµ· ${b.periodCount}${unit}`
        }
        return `${b.year}-${String(b.month).padStart(2,'0')}`
    }

    async function loadBudgets(){
        try{
            const arr=await fetchJSON(base+'/budgets')
            if(!arr || arr.length===0){
                bdTbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted)">æš‚æ— é¢„ç®—æ•°æ®,è¯·å…ˆåˆ›å»ºé¢„ç®—</td></tr>'
                return
            }
            
            const rows = await Promise.all(arr.map(async b=>{
                let ratePct=0, statusHtml=''
                
                if(b.startDate && b.periodUnit){
                    // å‘¨æœŸå‹é¢„ç®— - ä½¿ç”¨ç»Ÿè®¡åˆ†æ
                    const stats=await getStats(b.id)
                    if(stats){
                        ratePct=Math.round((stats.amountSpent/b.amount)*100)
                        
                        if(stats.willBeOverspentByAvg){
                            statusHtml=`<span class='alert'>âš ï¸ é¢„æµ‹è¶…æ”¯ Â¥${Math.abs(stats.projectedRemainingByAvgSoFar).toFixed(2)}</span>`
                        }else if(stats.remaining<0){
                            statusHtml=`<span class='alert'>è¶…é¢ Â¥${Math.abs(stats.remaining).toFixed(2)}</span>`
                        }else if(ratePct>=80){
                            statusHtml=`<span style='color:var(--warn)'>é¢„è­¦ ${ratePct}%</span>`
                        }else{
                            statusHtml=`<span style='color:var(--accent)'>âœ“ å¥åº·</span>`
                        }
                    }
                }else{
                    // æœˆåº¦é¢„ç®— - ä½¿ç”¨åŸæœ‰é€»è¾‘
                    try{
                        const u=await usageInfo(b)
                        ratePct=Math.round((u.rate||0)*100)
                        if(u.over){
                            statusHtml=`<span class='alert'>è¶…é¢ Â¥${u.overAmount.toFixed(2)}</span>`
                        }else if(ratePct>=80){
                            statusHtml=`<span style='color:var(--warn)'>é¢„è­¦ ${ratePct}%</span>`
                        }else{
                            statusHtml=`<span style='color:var(--accent)'>âœ“ æ­£å¸¸</span>`
                        }
                    }catch(e){
                        console.error('è·å–é¢„ç®—ä½¿ç”¨ç‡å¤±è´¥:', e)
                    }
                }
                
                return `<tr>
        <td>${b.categoryId||'æ€»é¢„ç®—'}</td>
        <td style='text-align:right;font-weight:bold'>Â¥${(b.amount||0).toFixed(2)}</td>
        <td>${formatPeriod(b)}</td>
        <td><div class='usage'><div class='bar-bg'><div class='bar' style='width:${Math.min(ratePct,100)}%'></div></div><span style='font-size:12px;min-width:35px'>${ratePct}%</span></div></td>
        <td>${statusHtml}</td>
        <td>
            ${b.startDate?`<button class='btn' data-id='${b.id}' data-action='detail'>è¯¦æƒ…</button> `:''}
            <button class='btn' data-id='${b.id}' data-action='del'>åˆ é™¤</button>
        </td>
      </tr>`
            }))
            bdTbody.innerHTML=rows.join('')
        }catch(e){
            console.error('åŠ è½½é¢„ç®—å¤±è´¥:', e)
            bdTbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--warn)">åŠ è½½å¤±è´¥: '+e.message+'</td></tr>'
        }
    }

    bdTbody.onclick=async(e)=>{
        const btn=e.target.closest('button'); if(!btn) return
        const id=btn.getAttribute('data-id'); const action=btn.getAttribute('data-action')
        if(action==='del'){
            await fetch(base+'/budgets/'+id,{method:'DELETE',headers:{'Authorization':'Bearer '+token}})
            loadBudgets()
        }else if(action==='detail'){
            showBudgetDetail(id)
        }
    }
    
    // æ˜¾ç¤ºé¢„ç®—è¯¦ç»†ç»Ÿè®¡
    async function showBudgetDetail(budgetId){
        const stats=await getStats(budgetId)
        if(!stats||!stats.budget.startDate){
            alert('è¯¥é¢„ç®—æš‚æ— è¯¦ç»†ç»Ÿè®¡æ•°æ®')
            return
        }
        
        const s=stats
        let msg=`ğŸ“Š é¢„ç®—ç»Ÿè®¡åˆ†æ\n\n`
        msg+=`ğŸ“… å‘¨æœŸ: ${s.budget.startDate} è‡³ ${s.budget.endDate}\n`
        msg+=`ğŸ’° æ€»é¢„ç®—: Â¥${s.budget.amount.toFixed(2)}\n`
        msg+=`âœ… å·²æ¶ˆè´¹: Â¥${s.amountSpent.toFixed(2)}\n`
        msg+=`ğŸ’µ å‰©ä½™: Â¥${s.remaining.toFixed(2)}\n\n`
        msg+=`ğŸ“ˆ æ—¥å‡é¢„ç®—: Â¥${s.avgPerDayBudget.toFixed(2)}/å¤©\n`
        msg+=`ğŸ“‰ å®é™…æ—¥å‡: Â¥${s.avgPerDayActual.toFixed(2)}/å¤©\n`
        msg+=`â±ï¸ å·²ç»è¿‡ ${s.daysElapsed}/${s.totalDays} å¤©\n\n`
        
        if(s.willBeOverspentByAvg){
            msg+=`âš ï¸ è¶…æ”¯é¢„è­¦: æŒ‰å½“å‰é€Ÿç‡ï¼Œé¢„è®¡æ€»æ¶ˆè´¹ Â¥${s.projectedTotalByAvgSoFar.toFixed(2)}\n`
            msg+=`   é¢„è®¡è¶…æ”¯ Â¥${Math.abs(s.projectedRemainingByAvgSoFar).toFixed(2)}\n\n`
        }else{
            msg+=`âœ… é¢„ç®—å¥åº·: æŒ‰å½“å‰é€Ÿç‡ï¼Œé¢„è®¡å‰©ä½™ Â¥${s.projectedRemainingByAvgSoFar.toFixed(2)}\n\n`
        }
        
        if(s.last7DaysSpent>0){
            msg+=`ğŸ“† è¿‘7å¤©æ¶ˆè´¹: Â¥${s.last7DaysSpent.toFixed(2)}\n`
        }
        if(s.last30DaysSpent>0){
            msg+=`ğŸ“† è¿‘30å¤©æ¶ˆè´¹: Â¥${s.last30DaysSpent.toFixed(2)}\n`
        }
        
        alert(msg)
    }
    
    loadBudgets()
